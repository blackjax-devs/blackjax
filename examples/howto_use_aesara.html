
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Use with Aesara models &#8212; Blackjax</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Use with Numpyro models" href="howto_use_numpyro.html" />
    <link rel="prev" title="Use the model I built with X?" href="../howto_use_ppl.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/blackjax.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Blackjax</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  HOW TO
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../howto_use_ppl.html">
   Use the model I built with X?
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Use with Aesara models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="howto_use_numpyro.html">
     Use with Numpyro models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="howto_use_oryx.html">
     Use with Oryx models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="howto_use_tfp.html">
     Use with TFP models
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="howto_sample_multiple_chains.html">
   Sample with multiple chains?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="howto_custom_gradients.html">
   Use custom gradients?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="howto_other_frameworks.html">
   Use non-JAX log-prob functions?
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Blackjax by example
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../examples.html">
   Examples
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="Introduction.html">
     A Quick Introduction to Blackjax
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="LogisticRegression.html">
     Bayesian Logistic Regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="LogisticRegressionWithLatentGaussianSampler.html">
     Bayesian Logistic Regression With Latent Gaussian Sampler
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="TemperedSMC.html">
     Use Tempered SMC to Improve Exploration of MCMC Methods.
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="HierarchicalBNN.html">
     Hierarchical Bayesian Neural Networks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="PeriodicOrbitalMCMC.html">
     Periodic Orbital MCMC
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="GP_EllipticalSliceSampler.html">
     Gaussian Regression with the Elliptical Slice Sampler
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="GP_Marginal.html">
     Bayesian Regression With Latent Gaussian Sampler
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="SGMCMC.html">
     MNIST Digit Recognition With a 3-Layer Perceptron
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="change_of_variable_hmc.html">
     Change of Variable in HMC
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Pathfinder.html">
     Pathfinder
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="RegimeSwitchingModel.html">
     Regime switching Hidden Markov model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="SparseLogisticRegression.html">
     Sparse logistic regression
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  API Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../mcmc.html">
   MCMC sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../sgmcmc.html">
   Stochastic gradient MCMC
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../smc.html">
   Sequential Monte Carlo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../vi.html">
   Variational Inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../adaptation.html">
   Adaptation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../diagnostics.html">
   Diagnostics
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/blackjax-devs/blackjax"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Use with Aesara models</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="use-with-aesara-models">
<h1>Use with Aesara models<a class="headerlink" href="#use-with-aesara-models" title="Permalink to this headline">#</a></h1>
<p>Blackjax accepts any log-probability function as long as it is compatible with <code class="docutils literal notranslate"><span class="pre">jax.jit</span></code>, <code class="docutils literal notranslate"><span class="pre">jax.grad</span></code> (for gradient-based samplers) and <code class="docutils literal notranslate"><span class="pre">jax.vmap</span></code>. In this example we will show ho we can use <a class="reference external" href="https://github.com/aesara-devs/aesara">Aesara</a> as a modeling language and Blackjax as an inference library.</p>
<div class="admonition-before-you-start admonition">
<p class="admonition-title">Before you start</p>
<p>You will need <a class="reference external" href="https://github.com/aesara-devs/aesara">Aesara</a> and <a class="reference external" href="https://github.com/aesara-devs/aeppl">AePPL</a> to run this example. Please follow the installation instructions on their respective repository.</p>
</div>
<p>We will implement the following Binomial response model for the rat tumor dataset:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
Y &amp;\sim \operatorname{Binomial}(N, \theta)\\
\theta &amp;\sim \operatorname{Beta}(\alpha, \beta)\\
\alpha, \beta &amp;\sim \frac{1}{(\alpha + \beta)^{2.5}}
\end{align*}\end{split}\]</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># index of array is type of tumor and value shows number of total people tested.
group_size = [20, 20, 20, 20, 20, 20, 20, 19, 19, 19, 19, 18, 18, 17, 20, 20, 20, 20, 19, 19, 18, 18, 25, 24, 23, 20, 20, 20, 20, 20, 20, 10, 49, 19, 46, 27, 17, 49, 47, 20, 20, 13, 48, 50, 20, 20, 20, 20, 20, 20, 20, 48, 19, 19, 19, 22, 46, 49, 20, 20, 23, 19, 22, 20, 20, 20, 52, 46, 47, 24, 14]

# index of array is type of tumor and value shows number of positve people.
n_of_positives = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 5, 2, 5, 3, 2, 7, 7, 3, 3, 2, 9, 10, 4, 4, 4, 4, 4, 4, 4, 10, 4, 4, 4, 5, 11, 12, 5, 5, 6, 5, 6, 6, 6, 6, 16, 15, 15, 9, 4]

n_rat_tumors = len(group_size)
</pre></div>
</div>
</div>
</details>
</div>
<p>We implement the generative model in two parts, the improper prior on <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> and then the response model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import aesara
import aesara.tensor as at

from aeppl import joint_logprob

# improper prior on `a` and `b`.
a_vv = at.scalar(&#39;a&#39;)
b_vv = at.scalar(&#39;b&#39;)
logprior = -2.5 * at.log(a_vv + b_vv)

# response model
srng = at.random.RandomStream(0)
theta_rv = srng.beta(a_vv, b_vv, size=(n_rat_tumors,))
Y_rv = srng.binomial(group_size, theta_rv)
</pre></div>
</div>
</div>
</div>
<p>We can then easily compile a function that samples from the prior predictive distribution, i.e. returns values of <code class="docutils literal notranslate"><span class="pre">Y_rv</span></code> based on the variables’ prior distribution. Let us make this function depend on the values of <code class="docutils literal notranslate"><span class="pre">a_vv</span></code> and <code class="docutils literal notranslate"><span class="pre">b_vv</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>prior_predictive_fn = aesara.function((a_vv, b_vv), Y_rv)
print(prior_predictive_fn(.5, .5))
print(prior_predictive_fn(.1, .3))
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[17 20  6  0  4 20  1 19  9  4  7  1 16  7 19  6 15  0 18 19 17  0  7  6
  2  0 20  0 20 10  1  2 17 15  0  6 12 49  0  0  8 13 27 35 20 15 17 10
 16 18  3 13 17  7  2  6  1  0 14  0 15 12  1  8 12 18  6 41 33 17  8]
[ 0  0  0  8  0  0  1 17  0  0  2 17  5  0  0  0  0 13 19  0 18  0  7 22
  0  0 20  0 16 13 20  0  0  0  0 10  0  0 44  0  0  0  0  6  0 20  0  0
  0 15  8  0  0  5  0  0  0 19 12  6  0 19  0  0 20 20 24  9 46  0  0]
</pre></div>
</div>
</div>
</div>
<p>To sample from the posterior distribution of <code class="docutils literal notranslate"><span class="pre">theta_rv</span></code>, <code class="docutils literal notranslate"><span class="pre">a_rv</span></code> and <code class="docutils literal notranslate"><span class="pre">b_rv</span></code> we need to be able to compute the model’s joint log-density. In AePPL, we use <code class="docutils literal notranslate"><span class="pre">joint_logprob</span></code> to build the graph of the joint log-density from the model graph:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>loglikelihood, (y_vv, theta_vv) = joint_logprob(Y_rv, theta_rv)
logprob = logprior + loglikelihood
</pre></div>
</div>
</div>
</div>
<p>However, the Beta distribution generates samples between 0 and 1 and gradient-based algorithms like NUTS work better on unbounded intervals. We can tell AePPL to apply a log-odds transformation to the Beta-distributed variable, and subsequently sample in the transformed space:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from aeppl.transforms import TransformValuesRewrite, LogOddsTransform

transforms_op = TransformValuesRewrite(
     {theta_rv: LogOddsTransform()}
)
loglikelihood, (y_vv, theta_vv) = joint_logprob(Y_rv, theta_rv, extra_rewrites=transforms_op)
logprob = logprior + loglikelihood
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>NUTS is not the best sampler for this model: the Beta distribution is the conjugate distribution of the Binomial. Marginalizing would lead to a faster sampler with less variance. <a class="reference external" href="https://github.com/aesara-devs/aemcmc">AeMCMC</a> (in alpha state) makes this kind of transformation automatically on Aesara models.</p>
</div>
<p>You can alway debug the <code class="docutils literal notranslate"><span class="pre">logprob</span></code> graph by printing it:</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>aesara.dprint(logprob)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Elemwise{add,no_inplace} [id A]
 |Elemwise{mul,no_inplace} [id B]
 | |TensorConstant{-2.5} [id C]
 | |Elemwise{log,no_inplace} [id D]
 |   |Elemwise{add,no_inplace} [id E]
 |     |a [id F]
 |     |b [id G]
 |Sum{acc_dtype=float64} [id H]
   |MakeVector{dtype=&#39;float64&#39;} [id I]
     |Sum{acc_dtype=float64} [id J]
     | |Elemwise{add,no_inplace} [id K]
     |   |Check{0 &lt;= value &lt;= 1, alpha &gt; 0, beta &gt; 0} [id L]
     |   | |Elemwise{switch,no_inplace} [id M]
     |   | | |Elemwise{and_,no_inplace} [id N]
     |   | | | |Elemwise{ge,no_inplace} [id O]
     |   | | | | |TransformedVariable [id P]
     |   | | | | | |Elemwise{sigmoid,no_inplace} [id Q]
     |   | | | | | | |&lt;TensorType(float64, (71,))&gt; [id R]
     |   | | | | | |&lt;TensorType(float64, (71,))&gt; [id R]
     |   | | | | |InplaceDimShuffle{x} [id S]
     |   | | | |   |TensorConstant{0.0} [id T]
     |   | | | |Elemwise{le,no_inplace} [id U]
     |   | | |   |TransformedVariable [id P]
     |   | | |   |InplaceDimShuffle{x} [id V]
     |   | | |     |TensorConstant{1.0} [id W]
     |   | | |Elemwise{sub,no_inplace} [id X]
     |   | | | |Elemwise{add,no_inplace} [id Y]
     |   | | | | |Elemwise{switch,no_inplace} [id Z]
     |   | | | | | |InplaceDimShuffle{x} [id BA]
     |   | | | | | | |Elemwise{eq,no_inplace} [id BB]
     |   | | | | | |   |a [id F]
     |   | | | | | |   |TensorConstant{1.0} [id BC]
     |   | | | | | |InplaceDimShuffle{x} [id BD]
     |   | | | | | | |TensorConstant{0.0} [id BE]
     |   | | | | | |Elemwise{mul,no_inplace} [id BF]
     |   | | | | |   |InplaceDimShuffle{x} [id BG]
     |   | | | | |   | |Elemwise{sub,no_inplace} [id BH]
     |   | | | | |   |   |a [id F]
     |   | | | | |   |   |TensorConstant{1.0} [id BI]
     |   | | | | |   |Elemwise{log,no_inplace} [id BJ]
     |   | | | | |     |TransformedVariable [id P]
     |   | | | | |Elemwise{switch,no_inplace} [id BK]
     |   | | | |   |InplaceDimShuffle{x} [id BL]
     |   | | | |   | |Elemwise{eq,no_inplace} [id BM]
     |   | | | |   |   |b [id G]
     |   | | | |   |   |TensorConstant{1.0} [id BN]
     |   | | | |   |InplaceDimShuffle{x} [id BO]
     |   | | | |   | |TensorConstant{0.0} [id BP]
     |   | | | |   |Elemwise{mul,no_inplace} [id BQ]
     |   | | | |     |InplaceDimShuffle{x} [id BR]
     |   | | | |     | |Elemwise{sub,no_inplace} [id BS]
     |   | | | |     |   |b [id G]
     |   | | | |     |   |TensorConstant{1.0} [id BT]
     |   | | | |     |Elemwise{log1p,no_inplace} [id BU]
     |   | | | |       |Elemwise{neg,no_inplace} [id BV]
     |   | | | |         |TransformedVariable [id P]
     |   | | | |InplaceDimShuffle{x} [id BW]
     |   | | |   |Elemwise{sub,no_inplace} [id BX]
     |   | | |     |Elemwise{add,no_inplace} [id BY]
     |   | | |     | |Elemwise{gammaln,no_inplace} [id BZ]
     |   | | |     | | |a [id F]
     |   | | |     | |Elemwise{gammaln,no_inplace} [id CA]
     |   | | |     |   |b [id G]
     |   | | |     |Elemwise{gammaln,no_inplace} [id CB]
     |   | | |       |Elemwise{add,no_inplace} [id CC]
     |   | | |         |a [id F]
     |   | | |         |b [id G]
     |   | | |InplaceDimShuffle{x} [id CD]
     |   | |   |TensorConstant{-inf} [id CE]
     |   | |All [id CF]
     |   | | |Elemwise{gt,no_inplace} [id CG]
     |   | |   |a [id F]
     |   | |   |TensorConstant{0.0} [id CH]
     |   | |All [id CI]
     |   |   |Elemwise{gt,no_inplace} [id CJ]
     |   |     |b [id G]
     |   |     |TensorConstant{0.0} [id CK]
     |   |Elemwise{add,no_inplace} [id CL]
     |     |Elemwise{log,no_inplace} [id CM]
     |     | |Elemwise{sigmoid,no_inplace} [id CN]
     |     |   |&lt;TensorType(float64, (71,))&gt; [id R]
     |     |Elemwise{log1p,no_inplace} [id CO]
     |       |Elemwise{neg,no_inplace} [id CP]
     |         |Elemwise{sigmoid,no_inplace} [id CN]
     |Sum{acc_dtype=float64} [id CQ]
       |Check{0 &lt;= p, p &lt;= 1} [id CR]
         |Elemwise{switch,no_inplace} [id CS]
         | |Elemwise{and_,no_inplace} [id CT]
         | | |Elemwise{le,no_inplace} [id CU]
         | | | |InplaceDimShuffle{x} [id CV]
         | | | | |TensorConstant{0} [id CW]
         | | | |&lt;TensorType(int64, (71,))&gt; [id CX]
         | | |Elemwise{le,no_inplace} [id CY]
         | |   |&lt;TensorType(int64, (71,))&gt; [id CX]
         | |   |TensorConstant{[20 20 20 .. 47 24 14]} [id CZ]
         | |Elemwise{add,no_inplace} [id DA]
         | | |Elemwise{add,no_inplace} [id DB]
         | | | |Elemwise{sub,no_inplace} [id DC]
         | | | | |Elemwise{sub,no_inplace} [id DD]
         | | | | | |Elemwise{gammaln,no_inplace} [id DE]
         | | | | | | |Elemwise{add,no_inplace} [id DF]
         | | | | | |   |TensorConstant{[20 20 20 .. 47 24 14]} [id CZ]
         | | | | | |   |InplaceDimShuffle{x} [id DG]
         | | | | | |     |TensorConstant{1} [id DH]
         | | | | | |Elemwise{gammaln,no_inplace} [id DI]
         | | | | |   |Elemwise{add,no_inplace} [id DJ]
         | | | | |     |&lt;TensorType(int64, (71,))&gt; [id CX]
         | | | | |     |InplaceDimShuffle{x} [id DK]
         | | | | |       |TensorConstant{1} [id DL]
         | | | | |Elemwise{gammaln,no_inplace} [id DM]
         | | | |   |Elemwise{add,no_inplace} [id DN]
         | | | |     |Elemwise{sub,no_inplace} [id DO]
         | | | |     | |TensorConstant{[20 20 20 .. 47 24 14]} [id CZ]
         | | | |     | |&lt;TensorType(int64, (71,))&gt; [id CX]
         | | | |     |InplaceDimShuffle{x} [id DP]
         | | | |       |TensorConstant{1} [id DQ]
         | | | |Elemwise{switch,no_inplace} [id DR]
         | | |   |Elemwise{eq,no_inplace} [id DS]
         | | |   | |TransformedVariable [id P]
         | | |   | |InplaceDimShuffle{x} [id DT]
         | | |   |   |TensorConstant{0} [id DU]
         | | |   |Elemwise{switch,no_inplace} [id DV]
         | | |   | |Elemwise{eq,no_inplace} [id DW]
         | | |   | | |&lt;TensorType(int64, (71,))&gt; [id CX]
         | | |   | | |InplaceDimShuffle{x} [id DX]
         | | |   | |   |TensorConstant{0} [id DY]
         | | |   | |InplaceDimShuffle{x} [id DZ]
         | | |   | | |TensorConstant{0.0} [id EA]
         | | |   | |InplaceDimShuffle{x} [id EB]
         | | |   |   |TensorConstant{-inf} [id EC]
         | | |   |Elemwise{mul,no_inplace} [id ED]
         | | |     |&lt;TensorType(int64, (71,))&gt; [id CX]
         | | |     |Elemwise{log,no_inplace} [id EE]
         | | |       |TransformedVariable [id P]
         | | |Elemwise{switch,no_inplace} [id EF]
         | |   |Elemwise{eq,no_inplace} [id EG]
         | |   | |Elemwise{sub,no_inplace} [id EH]
         | |   | | |InplaceDimShuffle{x} [id EI]
         | |   | | | |TensorConstant{1.0} [id EJ]
         | |   | | |TransformedVariable [id P]
         | |   | |InplaceDimShuffle{x} [id EK]
         | |   |   |TensorConstant{0} [id EL]
         | |   |Elemwise{switch,no_inplace} [id EM]
         | |   | |Elemwise{eq,no_inplace} [id EN]
         | |   | | |Elemwise{sub,no_inplace} [id EO]
         | |   | | | |TensorConstant{[20 20 20 .. 47 24 14]} [id CZ]
         | |   | | | |&lt;TensorType(int64, (71,))&gt; [id CX]
         | |   | | |InplaceDimShuffle{x} [id EP]
         | |   | |   |TensorConstant{0} [id EQ]
         | |   | |InplaceDimShuffle{x} [id ER]
         | |   | | |TensorConstant{0.0} [id ES]
         | |   | |InplaceDimShuffle{x} [id ET]
         | |   |   |TensorConstant{-inf} [id EU]
         | |   |Elemwise{mul,no_inplace} [id EV]
         | |     |Elemwise{sub,no_inplace} [id EO]
         | |     |Elemwise{log,no_inplace} [id EW]
         | |       |Elemwise{sub,no_inplace} [id EH]
         | |InplaceDimShuffle{x} [id EX]
         |   |TensorConstant{-inf} [id EY]
         |All [id EZ]
         | |Elemwise{le,no_inplace} [id FA]
         |   |InplaceDimShuffle{x} [id FB]
         |   | |TensorConstant{0.0} [id FC]
         |   |TransformedVariable [id P]
         |All [id FD]
           |Elemwise{le,no_inplace} [id FE]
             |TransformedVariable [id P]
             |InplaceDimShuffle{x} [id FF]
               |TensorConstant{1.0} [id FG]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;ipykernel.iostream.OutStream at 0x7f5932898820&gt;
</pre></div>
</div>
</div>
</div>
<p>To sample with Blackjax we will need to use Aesara’s JAX backend; <code class="docutils literal notranslate"><span class="pre">logprob_jax</span></code> defined below is a function that uses JAX operators, can be passed as an argument to <code class="docutils literal notranslate"><span class="pre">jax.jit</span></code> and <code class="docutils literal notranslate"><span class="pre">jax.grad</span></code>:</p>
<div class="cell tag_remove-stderr docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>logprob_fn = aesara.function((a_vv, b_vv, theta_vv, y_vv), logprob, mode=&quot;JAX&quot;)
logprob_jax = logprob_fn.vm.jit_fn
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>Let’s wrap this function to make our life simpler:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">logprob_jax</span></code> returns a tuple with a single element, but JAX can only differentiate scalar values and will complain.</p></li>
<li><p>We would like to work with dictionaries for the values of the variables;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Y_vv</span></code> is observed, so let’s fix its value.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def logprob_fn(position):
    flat_position = tuple(position.values())
    return logprob_jax(*flat_position, n_of_positives)[0]
</pre></div>
</div>
</div>
</div>
<p>Let’s define the initial position from which we are going to start sampling:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import jax

def init_param_fn(seed):
    &quot;&quot;&quot;
    initialize a, b &amp; thetas
    &quot;&quot;&quot;
    key1, key2 = jax.random.split(seed)
    return {
        &quot;a&quot;: jax.random.uniform(key1, (), &quot;float64&quot;, minval=0, maxval=3),
        &quot;b&quot;: jax.random.uniform(key2, (), &quot;float64&quot;, minval=0, maxval=3),
        &quot;thetas&quot;: jax.random.uniform(seed, (n_rat_tumors,), &quot;float64&quot;, minval=0, maxval=1),
    }

rng_key = jax.random.PRNGKey(0)
init_position = init_param_fn(rng_key)
</pre></div>
</div>
</div>
</div>
<p>And finally sample using Blackjax:</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def inference_loop(
    rng_key, kernel, initial_states, num_samples
):
    @jax.jit
    def one_step(states, rng_key):
        states, infos = kernel(rng_key, states)
        return states, (states, infos)

    keys = jax.random.split(rng_key, num_samples)
    _, (states, infos) = jax.lax.scan(one_step, initial_states, keys)

    return (states, infos)
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import blackjax

n_adapt = 3000
n_samples = 1000

adapt = blackjax.window_adaptation(blackjax.nuts, logprob_fn)
state, kernel, _ = adapt.run(rng_key, init_position, n_adapt)

states, infos = inference_loop(
    rng_key, kernel, state, n_samples
)
</pre></div>
</div>
</div>
</div>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../howto_use_ppl.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Use the model I built with X?</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="howto_use_numpyro.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Use with Numpyro models</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The Blackjax developers<br/>
  
      &copy; Copyright 2022, The Blackjax developers.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>